/**
 * RetroWebLauncher - Safari/WebKit Optimizations
 * Specific fixes and enhancements for Safari on macOS, iOS, iPadOS, and Apple TV
 */

/* ================================================
   Safari Detection
   ================================================ */
@supports (-webkit-touch-callout: none) {
  /* These styles only apply to Safari/WebKit */

  /* ================================================
     Performance Optimizations
     ================================================ */

  /* Hardware acceleration for animations */
  .animate,
  .swiper-slide,
  .game-card,
  [class*="animate__"] {
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
  }

  /* Prevent rendering bugs during animations */
  .transitioning {
    -webkit-transform: translate3d(0, 0, 0);
    transform: translate3d(0, 0, 0);
  }

  /* ================================================
     iOS Safe Area Handling
     ================================================ */

  /* Respect notch and home indicator */
  body {
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
  }

  /* Fixed elements need safe area consideration */
  .fixed-header {
    padding-top: env(safe-area-inset-top);
  }

  .fixed-footer {
    padding-bottom: env(safe-area-inset-bottom);
  }

  /* ================================================
     Touch Optimizations
     ================================================ */

  /* Disable callout on long press */
  * {
    -webkit-touch-callout: none;
  }

  /* Enable it for links that should show menus */
  a[href],
  button {
    -webkit-touch-callout: default;
  }

  /* Disable text selection on interactive elements */
  button,
  .btn,
  .card,
  .clickable {
    -webkit-user-select: none;
    user-select: none;
  }

  /* Enable smooth scrolling with momentum */
  .scrollable,
  .scroll-container,
  [style*="overflow"] {
    -webkit-overflow-scrolling: touch;
  }

  /* Prevent gray highlight on tap */
  button,
  a,
  .clickable,
  .interactive {
    -webkit-tap-highlight-color: transparent;
  }

  /* ================================================
     Input Handling
     ================================================ */

  /* Prevent zoom on input focus (minimum 16px font) */
  input,
  textarea,
  select {
    font-size: 16px !important;
  }

  /* Better touch target sizing */
  button,
  .btn,
  [role="button"] {
    min-height: 44px;
    min-width: 44px;
  }

  /* ================================================
     Video Player (Native HLS Support)
     ================================================ */

  video {
    /* Enable inline playback on iOS */
    -webkit-playsinline: true;

    /* Optimize rendering */
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
  }

  /* Poster image handling */
  video::-webkit-media-controls-start-playback-button {
    display: none;
  }

  /* ================================================
     Backdrop Filter Support
     ================================================ */

  /* Safari has native backdrop-filter but needs prefix */
  .blur-bg,
  .glass,
  .frosted {
    -webkit-backdrop-filter: blur(10px);
    backdrop-filter: blur(10px);
  }

  .blur-heavy {
    -webkit-backdrop-filter: blur(20px);
    backdrop-filter: blur(20px);
  }

  /* ================================================
     Scrollbar Styling
     ================================================ */

  /* Hide scrollbars but keep scrollable on iOS */
  .hide-scrollbar {
    -webkit-overflow-scrolling: touch;
  }

  .hide-scrollbar::-webkit-scrollbar {
    display: none;
    width: 0;
    height: 0;
  }

  /* ================================================
     Font Rendering
     ================================================ */

  body {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
  }

  /* ================================================
     Animation Performance
     ================================================ */

  /* Use will-change sparingly for known animations */
  .will-animate {
    will-change: transform, opacity;
  }

  /* Remove will-change after animation completes */
  .animation-done {
    will-change: auto;
  }

  /* ================================================
     Image Rendering
     ================================================ */

  img {
    /* Crisp image rendering for pixel art */
    image-rendering: -webkit-optimize-contrast;
  }

  img.pixelated {
    image-rendering: pixelated;
  }

  /* ================================================
     Flex Gap Fallback (older Safari)
     ================================================ */

  /* Safari 14.0 and earlier don't support gap in flexbox */
  @supports not (gap: 1rem) {
    .flex-gap > * {
      margin-right: var(--spacing-md, 1rem);
      margin-bottom: var(--spacing-md, 1rem);
    }

    .flex-gap > *:last-child {
      margin-right: 0;
    }
  }

  /* ================================================
     Focus Styles
     ================================================ */

  /* Better focus visibility for keyboard/gamepad navigation */
  :focus-visible {
    outline: 3px solid var(--color-primary, #ff0066);
    outline-offset: 2px;
  }

  /* Remove default focus ring when using mouse/touch */
  :focus:not(:focus-visible) {
    outline: none;
  }
}

/* ================================================
   Apple TV Specific (tvOS)
   ================================================ */
@media (hover: none) and (pointer: coarse) and (min-width: 1280px) {
  /* Apple TV likely - larger touch targets and fonts */

  body {
    font-size: 18px;
  }

  button,
  .btn,
  [role="button"] {
    min-height: 60px;
    min-width: 60px;
    font-size: 1.1rem;
  }

  /* Larger game cards for 10-foot UI */
  .game-card {
    min-width: 280px;
  }

  /* Focus states more visible */
  :focus {
    outline-width: 4px;
    outline-offset: 4px;
    transform: scale(1.05);
  }
}

/* ================================================
   iPadOS Specific
   ================================================ */
@media (min-width: 768px) and (max-width: 1366px) and (-webkit-min-device-pixel-ratio: 2) {
  /* iPad-sized Safari */

  /* Larger tap targets for finger use */
  button,
  .btn {
    min-height: 48px;
  }

  /* Multi-column layouts for larger screen */
  .game-grid {
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  }
}

/* ================================================
   macOS Safari Specific
   ================================================ */
@media (hover: hover) and (pointer: fine) {
  @supports (-webkit-touch-callout: none) {
    /* macOS Safari with mouse/trackpad */

    /* Finer scrollbars */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Trackpad gesture hint */
    .swipe-hint::after {
      content: 'Swipe or scroll';
    }
  }
}

/* ================================================
   PWA Standalone Mode
   ================================================ */
@media (display-mode: standalone) {
  /* Running as installed PWA */

  body {
    /* Prevent pull-to-refresh on PWA */
    overscroll-behavior-y: contain;
  }

  /* Status bar space on iOS PWA */
  .pwa-header {
    padding-top: calc(env(safe-area-inset-top) + 8px);
  }
}

/* PWA standalone class (set by JavaScript) */
html.pwa-standalone {
  /* Prevent overscroll bounce */
  overscroll-behavior: none;
}

html.pwa-standalone body {
  /* Ensure full viewport coverage */
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  overflow: hidden;
}

/* ================================================
   iOS-Specific Adjustments
   ================================================ */
html.ios-device {
  /* Smoother touch scrolling */
  -webkit-overflow-scrolling: touch;
  /* Lock the viewport to prevent resize on navigation */
  height: 100%;
  overflow: hidden;
}

html.ios-device body {
  /* Prevent elastic scrolling on body */
  overscroll-behavior: none;
  /* Use fixed positioning to prevent viewport jumps */
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  height: 100%;
  overflow: hidden;
}

/* Ensure rwl-app fills the fixed body on iOS */
html.ios-device rwl-app {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  height: 100% !important;
  max-height: 100%;
}

/* iOS status bar transparent overlay (black-translucent) */
html.ios-device.pwa-standalone rwl-header,
html.ios-device.pwa-standalone .header,
html.ios-device.pwa-standalone .fixed-header {
  /* Extra padding for status bar when black-translucent */
  padding-top: calc(env(safe-area-inset-top, 20px) + 8px);
}

/* Ensure controls bar respects home indicator */
html.ios-device .controls-bar,
html.ios-device .fixed-footer,
html.ios-device .toolbar {
  padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 8px);
}

/* Fix for iOS keyboard pushing content */
html.ios-device input:focus,
html.ios-device textarea:focus {
  position: relative;
  z-index: 1000;
}

/* Prevent double-tap zoom on interactive elements */
html.ios-device button,
html.ios-device a,
html.ios-device .clickable {
  touch-action: manipulation;
}

/* ================================================
   iOS Landscape Adjustments
   ================================================ */
@media screen and (orientation: landscape) {
  html.ios-device .controls-bar {
    padding-left: env(safe-area-inset-left, 0);
    padding-right: env(safe-area-inset-right, 0);
  }

  html.ios-device .sidebar,
  html.ios-device rwl-sidebar {
    padding-left: env(safe-area-inset-left, 0);
  }

  html.ios-device .alphabet-bar {
    right: calc(env(safe-area-inset-right, 0) + 8px);
  }
}
